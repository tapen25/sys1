<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Logger (BPM Only)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f0f0; }
  input { padding: 10px; font-size: 1.2em; width: 200px; text-align: center; }
  button { padding: 15px 30px; font-size: 1.2em; margin: 10px; }
  #status, #debug { margin-top: 15px; }
</style>
</head>

<body>

<input type="text" id="subject-id" placeholder="被験者ID"><br>
<button id="start">Start</button>

<div id="status">停止中</div>
<div id="debug">---</div>

<script>
// ===============================
// シンセ（単一・固定）
// ===============================
const synth = new Tone.Synth({
  oscillator: { type: "sawtooth" },
  envelope: { attack: 0.1, release: 0.5 },
  volume: -6
}).toDestination();

// ===============================
// 変数
// ===============================
let isPlaying = false;
let bpm = 108;
let targetBPM = 108;
let noteIndex = 0;

let motionHistory = [];
const HISTORY_DURATION = 1500;
let currentStd = 0;

// ===============================
// メロディ（固定）
// ===============================
const pattern = [
  "C3","E3","G3",null,
  "C4","G3","E3",null
];

// ===============================
// Start
// ===============================
document.getElementById("start").onclick = async () => {
  const id = document.getElementById("subject-id").value.trim();
  if (!id) return alert("被験者IDを入力してください");

  await Tone.start();
  window.addEventListener("devicemotion", handleMotion);

  isPlaying = true;
  noteIndex = 0;
  playNext();

  setInterval(updateBPM, 100);

  document.getElementById("status").innerText = `計測中 (ID: ${id})`;
};

// ===============================
// 加速度処理
// ===============================
function handleMotion(e) {
  const a = e.accelerationIncludingGravity;
  if (!a) return;

  const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
  const now = performance.now();

  motionHistory.push({ t: now, v: mag });
  motionHistory = motionHistory.filter(d => now - d.t < HISTORY_DURATION);

  currentStd = computeStd(motionHistory.map(d => d.v));
  targetBPM = mapStdToBPM(currentStd);
}

// ===============================
// BPM更新
// ===============================
function updateBPM() {
  bpm += (targetBPM - bpm) * 0.05;

  document.getElementById("debug").innerText =
    `BPM: ${bpm.toFixed(1)} / STD: ${currentStd.toFixed(2)}`;
}

// ===============================
// BPMマッピング（テンポのみ）
// ===============================
const BASE_BPM = 108;
const BASE_STD = 2.5;
const RANGE = 0.10;

function mapStdToBPM(std) {
  if (std < 0.5) return bpm;

  const raw = BASE_BPM + (std - BASE_STD) * 4;
  const min = BASE_BPM * (1 - RANGE);
  const max = BASE_BPM * (1 + RANGE);

  return Math.min(Math.max(raw, min), max);
}

// ===============================
// 再生
// ===============================
function playNext() {
  if (!isPlaying) return;

  const note = pattern[noteIndex % pattern.length];
  const interval = 60 / bpm;

  if (note) synth.triggerAttackRelease(note, interval * 0.8);

  noteIndex++;
  setTimeout(playNext, interval * 1000);
}

// ===============================
// Utility
// ===============================
function computeStd(arr) {
  if (!arr.length) return 0;
  const m = arr.reduce((s,v)=>s+v,0)/arr.length;
  return Math.sqrt(arr.reduce((s,v)=>s+(v-m)**2,0)/arr.length);
}
</script>

</body>
</html>
